<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fibonacci Calculator I</title>
  <style>
    :root { --bg1:#667eea; --bg2:#764ba2; --brand:#4facfe; --brand2:#00f2fe; --ok:#56ab2f; --bad:#ff416c; --muted:#757f9a; }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background:linear-gradient(135deg,var(--bg1) 0%, var(--bg2) 100%); padding:10px;
    }
    .container{
      width:min(1400px,96vw); margin:0 auto; background:rgba(255,255,255,.96);
      border-radius:16px; box-shadow:0 10px 24px rgba(0,0,0,.12);
    }
    .header{
      background:linear-gradient(135deg,var(--brand) 0%, var(--brand2) 100%); color:#fff; padding:18px 16px; text-align:center;
      will-change:transform, opacity;
    }
    .header h1{ margin:0 0 6px; font-size:clamp(1.25rem,1.2rem + 1vw,2rem); text-shadow:0 1px 2px rgba(0,0,0,.25); }
    .header p{ margin:0; opacity:.95; font-size:.95rem; }

    .main{ display:grid; gap:16px; padding:16px; grid-template-columns: 1fr; }
    @media (min-width:900px){ .main{ grid-template-columns: 1fr 360px; padding:24px; gap:24px; } }

    .card{ background:#fff; border-radius:14px; padding:16px; border:1px solid rgba(0,0,0,.06); box-shadow:0 4px 12px rgba(0,0,0,.06); }
    .card h2{ margin:0 0 10px; font-size:1.1rem; border-bottom:2px solid var(--brand); padding-bottom:8px; }

    .form-group{ margin:12px 0; }
    .label{ display:block; font-size:.92rem; color:#444; margin-bottom:6px; font-weight:600; }
    input[type="number"], select, input[type="text"]{
      width:100%; border:2px solid #e1e5e9; border-radius:12px; padding:12px 14px; font-size:16px; transition:.2s border-color, .2s box-shadow;
    }
    input:focus, select:focus{ outline:none; border-color:var(--brand); box-shadow:0 0 0 3px rgba(79,172,254,.15); }

    .btn{ width:auto; border:0; border-radius:12px; padding:12px 14px; font-weight:700; cursor:pointer; background:linear-gradient(135deg,var(--brand) 0%, var(--brand2) 100%); color:#fff; margin:6px 0; font-size:15px; }
    .btn:hover{ filter:brightness(1.05); }
    .btn.ok{ background:linear-gradient(135deg,var(--ok), #a8e6cf); }
    .btn.bad{ background:linear-gradient(135deg,var(--bad), #ff6b6b); }
    .btn.gray{ background:linear-gradient(135deg,#757f9a,#d7dde8); }
    .btn.sm{ padding:8px 12px; font-weight:700; font-size:13px; border-radius:10px; }

    /* ghost buttons (‡πÑ‡∏°‡πà‡πÄ‡∏î‡πà‡∏ô) */
    .btn.ghost{ background:#fff; color:#495057; border:1px solid #e6e9ee; box-shadow:none; }
    .btn.ghost:hover{ background:#f7f9fc; }
    .btn.ghost.danger{ color:#b54d4d; border-color:#f1caca; }
    .btn.ghost.danger:hover{ background:#fff4f4; }

    .stats{ background:linear-gradient(135deg,#a8edea 0%, #fed6e3 100%); border-radius:12px; padding:18px; text-align:center; }
    .total{ font-size:1.4rem; font-weight:800; }
    .total.pos{ color:var(--ok);} .total.neg{ color:var(--bad);} .total.zero{ color:var(--muted);}  

    .series{ border-left:4px solid var(--brand); margin:14px 0; }
    .series .head{ display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #e9edf2; padding-bottom:10px; gap:8px; }
    .series .title{ font-weight:800; font-size:1.05rem; }
    .pill{ font-weight:800; padding:6px 10px; border-radius:999px; }
    .pill.pos{ background:rgba(86,171,47,.12); color:var(--ok);} 
    .pill.neg{ background:rgba(255,65,108,.12); color:var(--bad);} 
    .pill.zero{ background:rgba(117,127,154,.12); color:var(--muted);} 

    details.row{ border-bottom:1px dashed #e9edf2; padding:8px 0; }
    details.row summary{ list-style:none; display:flex; gap:8px; align-items:center; cursor:pointer; padding:10px 0; }
    details.row summary::-webkit-details-marker{ display:none; }
    .col-match{ flex:1 1 auto; min-width:0; }
    .truncate{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .col-odds,.col-stake,.col-fib{ flex:0 0 auto; font-size:.95rem; color:#444; }
    .badge-mini{ padding:2px 6px; border-radius:999px; font-weight:800; font-size:.75rem; }
    .badge-mini.win{ background:rgba(86,171,47,.15); color:var(--ok);} 
    .badge-mini.lose{ background:rgba(255,65,108,.15); color:var(--bad);} 
    .badge-mini.wait{ background:rgba(255,193,7,.15); color:#b8860b; }
    .row-detail{ padding:8px 8px 0 34px; color:#555; font-size:.9rem; }

    .controls-row{ display:flex; gap:10px; flex-wrap:wrap; }
    .inline-two{ display:flex; gap:10px; }
    .inline-two .field{ flex:1 1 50%; }

    .rows.scroll{ max-height:420px; overflow-y:auto; border-top:1px solid #eef1f4; }

    .fib{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{ display:inline-block; background:#ecf2ff; border:1px solid #e1e5e9; border-radius:8px; padding:6px 10px; font-weight:700; position:relative; }
    .chip .i{ position:absolute; top:-6px; right:-6px; width:16px; height:16px; border-radius:50%; background:#333; color:#fff; display:flex; align-items:center; justify-content:center; font-size:10px; }

    /* Modal */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.4); display:flex; align-items:center; justify-content:center; padding:16px; z-index:50; }
    .modal.hidden{ display:none; }
    .modal-card{ background:#fff; width:min(520px,92vw); border-radius:14px; box-shadow:0 10px 24px rgba(0,0,0,.2); overflow:hidden; }
    .modal-head{ display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid #eef1f4; }
    .modal-head h3{ margin:0; font-size:1.05rem; }
    .modal-body{ padding:16px; }
    .rand-list{ margin:0; padding-left:18px; line-height:1.8; font-size:1rem; }
    .close{ background:transparent; border:0; font-size:22px; cursor:pointer; }
    .btn-row{ display:flex; gap:10px; flex-wrap:wrap; }

    /* ---- Mobile hide-on-scroll ---- */
    @media (max-width:900px){
      .scroll-hide { transition: transform .25s ease, opacity .25s ease; will-change: transform, opacity; }
      .scroll-hide.hidden { transform: translateY(-110%); opacity: 0; pointer-events: none; }

      .scroll-collapse { transition: max-height .3s ease, opacity .2s ease, margin .2s ease, padding .2s ease, border-width .2s ease, box-shadow .2s ease; overflow: hidden; }
      .scroll-collapse.hidden { max-height: 0 !important; opacity: 0; margin: 0 !important; padding-top: 0 !important; padding-bottom: 0 !important; border-width: 0 !important; box-shadow: none !important; }

      /* ‡πÇ‡∏´‡∏°‡∏î keyboard-safe: Bottom sheet */
      body.kb #appHeader{ display:none !important; }
      body.kb #nextBetCard{
        position: fixed; left: 8px; right: 8px; bottom: env(safe-area-inset-bottom);
        margin: 0; border-radius: 14px 14px 0 0; max-height: 70vh; overflow:auto; z-index: 100;
        box-shadow:0 10px 24px rgba(0,0,0,.25);
      }
      body.kb .fab{ display:none !important; }
    }

    @media (min-width:900px){ #seriesList{ margin-top: 8px; } }
    @media (max-width:600px){
      .inline-two{ flex-direction:column; }
      input[type="number"], select, input[type="text"]{ font-size:18px; padding:14px 14px; }
      .btn{ font-size:16px; padding:14px 16px; }
      .series .head{ flex-direction:column; align-items:flex-start; }
      .col-odds,.col-stake,.col-fib{ font-size:1rem; }
    }

    /* FAB */
    .fab{
      position:fixed; right:16px; bottom:16px; z-index:40;
      background:linear-gradient(135deg,var(--brand),var(--brand2)); color:#fff; border:none; border-radius:999px;
      padding:14px 18px; font-weight:800; box-shadow:0 6px 18px rgba(0,0,0,.25); cursor:pointer; display:none;
    }
    .fab.show{ display:inline-flex; align-items:center; gap:8px; }

    /* ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á Series */
    .actions-top{ display:flex; align-items:center; gap:10px; margin:10px 0; flex-wrap:wrap; }
    .actions-left{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .actions-right{ display:flex; gap:8px; align-items:center; margin-left:auto; }
    @media (min-width:600px){ .actions-top{ flex-wrap:nowrap; } }

    /* ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡∏≠‡∏á Next Bet (‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏° Submit ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô) */
    .nb-head{ display:flex; align-items:center; gap:10px; margin-bottom:8px; }
    .nb-actions{ margin-left:auto; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .nb-title{ font-size:1.1rem; font-weight:800; border-bottom:2px solid var(--brand); padding-bottom:6px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header scroll-hide" id="appHeader">
      <h1>üéØ Fibonacci Calculator</h1>
      <p>
        Rule: lose ‚Üí next index, win ‚Üí step back <b>1</b> ‚Ä¢
        After any <b>win</b>: if <i>loss balance</i> &gt; <i>expected profit of next step</i>, then next stake = <b>ceil(loss √∑ net odds)</b> so that a <b>WW</b> returns to breakeven
      </p>
    </div>

    <div class="main">
      <section>
        <div class="stats">
          <div class="total" id="totalProfit">0</div>
        </div>

        <!-- Next Bet -->
        <div class="card scroll-collapse" id="nextBetCard" style="margin-top:12px">
          <div class="nb-head">
            <div class="nb-title">üéÆ Next Bet</div>
            <div class="nb-actions">
              <button class="btn" id="bettingBtnTop">üéØ Submit</button>
              <button class="btn gray" id="randomBtnTop">üé≤ Random</button>
            </div>
          </div>

          <!-- ORDER: Select Series -> Match name -> Odds -->
          <div class="inline-two">
            <div class="form-group field">
              <label class="label">Select Series</label>
              <select id="selectedSeries"><option value="">‚Äî Choose ‚Äî</option></select>
            </div>
            <div class="form-group field">
              <label class="label">Match name</label>
              <input type="text" id="matchName" placeholder="e.g., Team A vs Team B" />
            </div>
          </div>
          <div class="form-group field">
            <label class="label">Odds value</label>
            <input type="number" id="odds" value="0.85" step="0.01" min="0.01" max="100" />
          </div>

          <div class="card" style="background:#f8f9fa">
            <div id="betLines" style="line-height:1.6">
              <div>üíµ Stake: <b><span id="calculatedBet">0</span> ‡∏ø</b></div>
            </div>
          </div>
        </div>

        <!-- Series list -->
        <div id="seriesList"></div>
      </section>
      <section></section>
    </div>

    <!-- Series settings -->
    <section class="card" id="seriesSettingsSection" style="margin:0 16px 16px;">
      <h2>üìä Series Settings</h2>
      <div class="form-group">
        <label class="label">Base unit (THB)</label>
        <input type="number" id="minBet" value="25" min="1" />
      </div>

      <div class="card" style="background:#f8f9fa">
        <h3 style="margin:0 0 8px; font-size:1rem;">üî¢ Fibonacci Sequence</h3>
        <div class="fib" id="fibSequence"></div>
      </div>
      <div class="controls-row">
        <button class="btn" onclick="createNewSeries()">üìù New Series</button>
        <button class="btn ghost" onclick="resetAll()">üóëÔ∏è Reset All</button>
      </div>
    </section>
  </div>

  <!-- FAB -->
  <button class="fab" id="fabShow"><span>üìã</span> Next Bet</button>

  <!-- Random Modal -->
  <div class="modal hidden" id="randomModal" role="dialog" aria-modal="true" aria-labelledby="randTitle">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="randTitle">üé≤ Random Picks</h3>
        <button class="close" aria-label="Close" onclick="closeRandom()">√ó</button>
      </div>
      <div class="modal-body" id="randomResults"><!-- ‡πÅ‡∏™‡∏î‡∏á ? ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å --></div>
      <div class="controls-row" style="padding:12px 16px;">
        <button class="btn" onclick="doRandom()">üîÄ Re-roll</button>
        <button class="btn ghost" onclick="closeRandom()">Close</button>
      </div>
    </div>
  </div>

  <script>
  // ====== State ======
  let gameData = {
    minBet: 25,
    lastOdds: 0.85,
    fibSequence: [1,1,2,3,5,8,13,21,34,55,89,144],
    series: []
  };

  // ====== Persistence ======
  function loadData(){
    try{
      const saved = JSON.parse(localStorage.getItem('fibonacciBettingNew')||'{}');
      gameData = { ...gameData, ...saved };
    }catch(e){}
    const oddsInput = document.getElementById('odds');
    if(oddsInput){ oddsInput.value = String(gameData.lastOdds ?? 0.85); }
    updateDisplay();
  }
  function saveData(){ localStorage.setItem('fibonacciBettingNew', JSON.stringify(gameData)); }

  // ====== Math helpers ======
  const roundBaht = (n)=> Math.round(n);
  const ceilBaht  = (n)=> Math.ceil(n);
  function getNetOdds(odds){ const o = parseFloat(odds||0); return Math.max(0, o); }

  // ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤: ‡∏´‡∏•‡∏±‡∏á Win ‡∏ñ‡πâ‡∏≤ lossBalance > expectedProfit(‡∏™‡πÄ‡∏ï‡πá‡∏õ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ) => next stake = ceil(loss / netOdds)
  function calcStake(series, fibIndex, odds){
    const net = getNetOdds(odds);
    if(net <= 0) return { stake:0, target:0, netOdds:0, isAdjusted:false, defaultStake:0, expectedProfit:0, fibVal:1 };

    const idx = Math.min(fibIndex, gameData.fibSequence.length-1);
    const fibVal = gameData.fibSequence[idx];
    const base = series.minBet;

    const baseStake = Math.max(1, roundBaht((base * fibVal) / net));
    const expectedProfitBase = roundBaht(baseStake * net);

    const lossBal = Math.max(0, Number(series.lossBalance||0));
    let stake = baseStake;
    let isAdjusted = false;

    if ((series.winStreak||0) >= 1 && lossBal > 0 && lossBal > expectedProfitBase){
      stake = Math.max(1, ceilBaht(lossBal / net));
      isAdjusted = true;
    }
    return {
      stake,
      defaultStake: baseStake,
      isAdjusted,
      expectedProfit: roundBaht(stake * net),
      target: base * fibVal,
      netOdds: net,
      fibVal
    };
  }

  // ====== CRUD ======
  function createNewSeries(){
    const minBet = Math.max(1, parseInt(document.getElementById('minBet').value||'25'));
    gameData.minBet = minBet;
    const s = {
      id: Date.now(),
      name: `Series ${gameData.series.length+1}`,
      minBet,
      currentFibIndex: 0,
      games: [],
      totalProfit: 0,
      isCompleted: false,
      currentBetting: null,
      lossBalance: 0,
      winStreak: 0
    };
    gameData.series.push(s);
    updateDisplay(); saveData();
  }
  function resetAll(){
    if(!confirm('Reset all data?')) return;
    gameData = { minBet:25, lastOdds:0.85, fibSequence:[1,1,2,3,5,8,13,21,34,55,89,144], series:[] };
    updateDisplay(); saveData();
  }

  // ====== Betting flow ======
  function startBetting(){
    const sid = parseInt(document.getElementById('selectedSeries').value);
    const name = (document.getElementById('matchName').value||'').trim();
    const odds = parseFloat(document.getElementById('odds').value);
    if(!sid){ alert('Please choose a series'); return; }
    if(!name){ alert('Please enter a match name'); return; }
    const series = gameData.series.find(s=>s.id===sid); if(!series) return;
    if(typeof series.lossBalance !== 'number') series.lossBalance = 0;
    if(typeof series.winStreak !== 'number') series.winStreak = 0;

    const C = calcStake(series, series.currentFibIndex, odds);
    if(!C.netOdds){ alert('Invalid odds'); return; }

    series.currentBetting = { matchName: name, odds, betAmount: C.stake, fibIndex: series.currentFibIndex, isAdjusted: C.isAdjusted };

    document.getElementById('selectedSeries').value = '';
    document.getElementById('matchName').value = '';
    gameData.lastOdds = isNaN(odds) ? 0.85 : odds; saveData();
    updateDisplay();
  }

  function recordResult(seriesId, isWin){
    const s = gameData.series.find(x=>x.id===seriesId); if(!s || !s.currentBetting) return;
    if(typeof s.lossBalance !== 'number') s.lossBalance = 0;
    if(typeof s.winStreak !== 'number') s.winStreak = 0;

    const b = s.currentBetting; const netOdds = getNetOdds(b.odds);
    const profitOnWin = roundBaht(b.betAmount * netOdds);
    const netProfit = isWin ? profitOnWin : -b.betAmount;

    if(isWin){
      s.currentFibIndex = Math.max(0, s.currentFibIndex - 1);
      s.winStreak = (s.winStreak||0) + 1;
      s.lossBalance = Math.max(0, (s.lossBalance||0) - profitOnWin);
      if(s.winStreak >= 2){ s.currentFibIndex = 0; s.winStreak = 0; }
    } else {
      s.currentFibIndex++;
      s.winStreak = 0;
      s.lossBalance = (s.lossBalance||0) + b.betAmount;
    }

    const rec = { matchName: b.matchName, odds: b.odds, fibIndex: b.fibIndex, betAmount: b.betAmount, result: isWin? 'Win':'Lose', adjusted: !!b.isAdjusted };
    s.games.push(rec); s.totalProfit += netProfit; s.currentBetting = null;
    updateDisplay(); saveData();
  }

  function completeSeries(id){
    const s = gameData.series.find(x=>x.id===id); if(!s) return;
    s.isCompleted = true; s.currentBetting = null; updateDisplay(); saveData();
  }
  function deleteSeries(id){
    if(!confirm('Delete this series?')) return;
    gameData.series = gameData.series.filter(x=>x.id!==id); updateDisplay(); saveData();
  }

  // ====== UI ======
  function truncTitle(input, max=30){
    const s = String(input || '');
    try{
      if(typeof Intl !== 'undefined' && Intl.Segmenter){
        const seg = new Intl.Segmenter('th', { granularity: 'grapheme' });
        const parts = Array.from(seg.segment(s), x => x.segment);
        if(parts.length > max) return parts.slice(0, max).join('') + '...';
        return s;
      }
    }catch(e){}
    return s.length > max ? s.slice(0, max) + '...' : s;
  }

  function updateDisplay(){
    const fc = document.getElementById('fibSequence');
    if(fc){
      fc.innerHTML='';
      gameData.fibSequence.forEach((v,i)=>{
        const e=document.createElement('span'); e.className='chip'; e.innerHTML=String(v)+`<span class="i">${i}</span>`; fc.appendChild(e);
      });
    }

    const sel = document.getElementById('selectedSeries');
    if(sel){
      sel.innerHTML='<option value="">‚Äî Choose ‚Äî</option>';
      gameData.series.filter(s=>!s.isCompleted).forEach(s=>{
        const o=document.createElement('option'); o.value=String(s.id); o.textContent=`${s.name} (index: ${s.currentFibIndex})`; sel.appendChild(o);
      });
    }

    updateBetCalculationPanel();
    renderSeries();
    renderTotals();
  }

  function updateBetCalculationPanel(){
    const sel = document.getElementById('selectedSeries');
    const oddsInput = document.getElementById('odds');
    const betSpan = document.getElementById('calculatedBet');
    const betLines = document.getElementById('betLines');
    if(!sel || !oddsInput || !betSpan || !betLines) return;

    function calc(){
      const sid = parseInt(sel.value);
      const s = gameData.series.find(x=>x.id===sid);
      if(!s){
        betSpan.textContent = '0';
        betLines.innerHTML = `<div>üíµ Stake: <b><span id="calculatedBet">0</span> ‡∏ø</b></div>`;
        return;
      }
      const odds = parseFloat(oddsInput.value)||0.85;
      const C = calcStake(s, s.currentFibIndex, odds);
      betSpan.textContent = (C.stake||0).toLocaleString();

      const badge = C.isAdjusted ? `<span class="badge-mini win" style="margin-left:8px">Adjusted for recovery</span>` : '';
      betLines.innerHTML = `
        <div>üíµ Stake: <b>${(C.stake||0).toLocaleString()} ‡∏ø</b> ${badge}</div>
        <div style="font-size:.9rem;color:#666">
          Fibo idx: <b>${s.currentFibIndex}</b> (√ó${C.fibVal}) ‚Ä¢ Default: ${C.defaultStake.toLocaleString()} ‡∏ø ‚Ä¢ Net odds: ${odds}
        </div>
        <div style="font-size:.9rem;color:#666">
          Expected profit if win: <b>${(C.expectedProfit||0).toLocaleString()} ‡∏ø</b> ‚Ä¢ Outstanding loss: <b>${(s.lossBalance||0).toLocaleString()} ‡∏ø</b>
        </div>
      `;
    }
    calc();
    sel.onchange = calc;
    oddsInput.oninput = function(){ gameData.lastOdds = parseFloat(this.value||'0.85')||0.85; saveData(); calc(); };
  }

  function renderSeries(){
    const wrap = document.getElementById('seriesList'); if(!wrap) return; wrap.innerHTML='';
    const list = gameData.series.slice().sort((a,b)=> a.id - b.id);
    list.forEach(s=>{
      const div = document.createElement('div'); div.className='card series';
      const pc = s.totalProfit>0? 'pill pos': (s.totalProfit<0? 'pill neg':'pill zero');
      div.innerHTML = `
        <div class="head">
          <div class="title">${s.name}</div>
          <div class="${pc}">${s.totalProfit>0?'+':''}${s.totalProfit.toLocaleString()} ‡∏ø</div>
        </div>
      `;

      const actionsTop = document.createElement('div'); actionsTop.className = 'actions-top';
      const left = document.createElement('div'); left.className = 'actions-left';
      const right = document.createElement('div'); right.className = 'actions-right';

      if(s.currentBetting){
        const btnW = document.createElement('button'); btnW.className = 'btn ok'; btnW.textContent = '‚úÖ Win'; btnW.onclick = function(){ recordResult(s.id, true); };
        const btnL = document.createElement('button'); btnL.className = 'btn bad'; btnL.textContent = '‚ùå Lose'; btnL.onclick = function(){ recordResult(s.id, false); };
        left.appendChild(btnW); left.appendChild(btnL);
      }
      const btnC = document.createElement('button'); btnC.className = 'btn sm ghost'; btnC.textContent = 'Close'; btnC.onclick = function(){ completeSeries(s.id); };
      const btnD = document.createElement('button'); btnD.className = 'btn sm ghost danger'; btnD.textContent = 'Delete'; btnD.onclick = function(){ deleteSeries(s.id); };
      right.appendChild(btnC); right.appendChild(btnD);

      actionsTop.appendChild(left); actionsTop.appendChild(right); div.appendChild(actionsTop);

      const rows = document.createElement('div'); rows.id = `rows-${s.id}`; rows.className = 'rows';
      div.appendChild(rows);
      wrap.appendChild(div);

      let rowCount = 0;
      if(s.currentBetting){
        const b = s.currentBetting; const mnShort = truncTitle(b.matchName);
        const d = document.createElement('details'); d.className='row'; d.open = false;
        d.innerHTML = `
          <summary>
            <span class="badge-mini wait">Betting</span>
            <span class="col-match truncate" title="${mnShort}">${mnShort}</span>
            <span class="col-odds">${b.odds}</span>
            <span class="col-stake"><b>${b.betAmount.toLocaleString()}‡∏ø</b>${b.isAdjusted? ' <span class="badge-mini win">Adj</span>':''}</span>
            <span class="col-fib">(${b.fibIndex})</span>
          </summary>
          <div class="row-detail">${b.matchName}</div>
        `;
        rows.appendChild(d); rowCount++;
      }

      const games = s.games.slice().reverse();
      games.forEach(function(g){
        const mnShort = truncTitle(g.matchName);
        const d = document.createElement('details'); d.className='row';
        d.innerHTML = `
          <summary>
            <span class="badge-mini ${g.result==='Win'?'win':'lose'}">${g.result}</span>
            <span class="col-match truncate" title="${mnShort}">${mnShort}</span>
            <span class="col-odds">${g.odds}</span>
            <span class="col-stake"><b>${g.betAmount.toLocaleString()}‡∏ø</b>${g.adjusted? ' <span class="badge-mini win">Adj</span>':''}</span>
            <span class="col-fib">(${g.fibIndex})</span>
          </summary>
          <div class="row-detail">${g.matchName}</div>
        `;
        rows.appendChild(d); rowCount++;
      });

      if(rowCount > 10){ rows.classList.add('scroll'); }
    });
  }

  function renderTotals(){
    const total = gameData.series.reduce((a,s)=> a + s.totalProfit, 0);
    const el = document.getElementById('totalProfit'); if(!el) return;
    el.textContent = (total>0?'+':'') + total.toLocaleString();
    el.className = 'total ' + (total>0? 'pos' : (total<0? 'neg':'zero'));
  }

  // ====== Random popup ======
  function randOf(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function rollAll(){
    const picks = { sides: randOf(['Home','Away']), ou: randOf(['Over','Under']), oe: randOf(['Odd','Even']) };
    const el = document.getElementById('randomResults');
    if(el){ el.innerHTML = `<ul class="rand-list"><li><b>Home/Away:</b> ${picks.sides}</li><li><b>Over/Under:</b> ${picks.ou}</li><li><b>Odd/Even:</b> ${picks.oe}</li></ul>`; }
  }
  function openRandom(){
    const m = document.getElementById('randomModal'); if (!m) return;
    m.classList.remove('hidden');
    const el = document.getElementById('randomResults');
    if (el && !el.innerHTML.trim()) {
      // ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÅ‡∏™‡∏î‡∏á ? ‡∏£‡∏≠‡∏Å‡∏≤‡∏£ Re-roll
      el.innerHTML = `<ul class="rand-list"><li><b>Home/Away:</b> ?</li><li><b>Over/Under:</b> ?</li><li><b>Odd/Even:</b> ?</li></ul>`;
    }
  }
  function closeRandom(){ const m = document.getElementById('randomModal'); if(!m) return; m.classList.add('hidden'); }
  function doRandom(){ rollAll(); }

  // ====== Hide-on-scroll + FAB + Keyboard-safe ======
  (function initUI(){
    const header = document.getElementById('appHeader');
    const nextBet = document.getElementById('nextBetCard');
    const fab = document.getElementById('fabShow');
    const submitTop = document.getElementById('bettingBtnTop');
    const randomTop = document.getElementById('randomBtnTop');
    if(!header || !nextBet || !fab) return;

    // map ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°
    submitTop.addEventListener('click', startBetting);
    randomTop.addEventListener('click', openRandom);

    const mql = window.matchMedia('(max-width: 900px)');
    let lastY = window.scrollY || 0;
    let ticking = false;
    let lockUI = false;
    let lockTimer = null;
    const THRESH = 12;

    function updateFab(){
      if(mql.matches && nextBet.classList.contains('hidden') && !document.body.classList.contains('kb')) fab.classList.add('show');
      else fab.classList.remove('show');
    }

    function onScroll(){
      if(ticking) return;
      ticking = true;
      window.requestAnimationFrame(()=>{
        const y = window.scrollY || 0;
        const dy = y - lastY;

        if(mql.matches){
          if(!lockUI){
            if(dy > THRESH){ header.classList.add('hidden'); nextBet.classList.add('hidden'); }
            else if(dy < -THRESH){ header.classList.remove('hidden'); nextBet.classList.remove('hidden'); }
            updateFab();
          }else{
            header.classList.add('hidden'); nextBet.classList.remove('hidden');
          }
        }else{
          header.classList.remove('hidden'); nextBet.classList.remove('hidden');
          updateFab();
        }

        lastY = y; ticking = false;
      });
    }

    // ‡πÅ‡∏ï‡∏∞‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î -> ‡∏•‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (‡πÑ‡∏ß‡πâ‡∏Å‡∏î Submit)
    nextBet.addEventListener('pointerdown', ()=>{
      lockUI = true;
      if(lockTimer) clearTimeout(lockTimer);
      lockTimer = setTimeout(()=>{ lockUI = false; }, 1200);
    });

    // FAB
    fab.addEventListener('click', ()=>{
      nextBet.classList.remove('hidden');
      header.classList.remove('hidden');
      updateFab();
      window.scrollTo({top: Math.max(0, window.scrollY - 80), behavior:'smooth'});
    });

    // Keyboard-safe: focus/blur
    const inputs = nextBet.querySelectorAll('input,select,textarea');
    inputs.forEach(el=>{
      el.addEventListener('focus', ()=>{
        document.body.classList.add('kb');
        lockUI = true;
        header.classList.add('hidden');
        nextBet.classList.remove('hidden');
        updateFab();
        setTimeout(()=>{ try{ el.scrollIntoView({block:'center', behavior:'smooth'}); }catch(e){} }, 60);
      });
      el.addEventListener('blur', ()=>{
        setTimeout(()=>{
          const active = document.activeElement;
          if(!nextBet.contains(active)){
            document.body.classList.remove('kb');
            lockUI = false;
            updateFab();
          }
        }, 80);
      });
    });

    // bind classes
    header.classList.add('scroll-hide');
    nextBet.classList.add('scroll-collapse');

    window.addEventListener('scroll', onScroll, {passive:true});
    window.addEventListener('resize', ()=>{
      if(!mql.matches){ header.classList.remove('hidden'); nextBet.classList.remove('hidden'); document.body.classList.remove('kb'); }
      updateFab();
    });
    updateFab();
  })();

  // ====== Init ======
  document.addEventListener('DOMContentLoaded', function(){
    loadData();
    const mb = document.getElementById('minBet');
    if(mb){ mb.addEventListener('change', function(){ gameData.minBet = Math.max(1, parseInt(this.value||'25')); updateDisplay(); saveData(); }); }
  });

  // expose
  window.createNewSeries = createNewSeries;
  window.resetAll = resetAll;
  window.startBetting = startBetting;
  window.recordResult = recordResult;
  window.completeSeries = completeSeries;
  window.deleteSeries = deleteSeries;
  window.openRandom = openRandom;
  window.closeRandom = closeRandom;
  window.doRandom = doRandom;
  </script>
</body>
</html>
