<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ตารางทุนที่ต้องใช้และความเสี่ยง — Fibonacci × (เริ่มต้น ÷ ค่าน้ำ)</title>
  <style>
    :root{
      --bg:#0b1020; --card:#0f1630; --muted:#a9b3c7; --text:#e8eefc;
      --accent:#6aa4ff; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:16px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020 0%,#0b1426 40%,#0b152a 100%);
      color:var(--text); font:16px/1.55 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow)}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;
      padding:18px 20px;border-bottom:1px solid rgba(255,255,255,.06)}
    header h1{font-size:18px;margin:0;font-weight:700}
    .controls{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;padding:16px;align-items:end}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:13px;letter-spacing:.2px;color:var(--muted)}
    .field input{background:#0d132a;color:var(--text);border:1px solid rgba(255,255,255,.08);
      border-radius:12px;padding:10px 12px;outline:none;transition:box-shadow .2s,border-color .2s}
    .field input:focus{box-shadow:0 0 0 6px rgba(106,164,255,.35);border-color:var(--accent)}
    button.primary{background:linear-gradient(180deg,var(--accent) 0%,#4a86f6 100%);
      color:#0a1020;border:none;border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer}
    button.primary:hover{filter:brightness(1.05)}
    .summary{display:flex;gap:16px;flex-wrap:wrap;padding:0 16px 16px}
    .pill{background:#0d132a;border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:8px 12px;font-size:13px;color:var(--muted)}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;z-index:1;background:#121a3a;color:#cdd6eb;font-size:12px;letter-spacing:.3px;
      text-transform:uppercase;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)}
    tbody td{padding:12px;border-bottom:1px dashed rgba(255,255,255,.06)}
    tbody tr{transition:background .15s,transform .08s}
    tbody tr:hover{background:rgba(255,255,255,.03)}
    tbody tr.clickable{cursor:pointer}
    .right{text-align:right} .muted{color:var(--muted)}
    .tag{font-size:11px;padding:4px 8px;border-radius:999px;background:#0f1a3a;border:1px solid rgba(255,255,255,.06);color:#cfe0ff}
    .scroll{max-height:60vh;overflow:auto;border-top:1px solid rgba(255,255,255,.06)}

    /* Popup on top & lock scroll */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;
      align-items:center;justify-content:center;padding:16px;z-index:9999
    }
    .modal{
      width:min(950px,98vw);background:var(--card);border:1px solid rgba(255,255,255,.08);
      border-radius:18px;box-shadow:var(--shadow);position:relative;z-index:10000;max-height:92vh;display:flex;flex-direction:column
    }
    .modal header{
      position:sticky;top:0;background:var(--card);
      border-bottom:1px solid rgba(255,255,255,.08);z-index:2;display:flex;align-items:center;justify-content:space-between;padding:14px 16px
    }
    .modal .content{padding:16px;overflow:auto}
    .modal .actions{position:sticky;bottom:0;background:var(--card);border-top:1px solid rgba(255,255,255,.08);
      display:flex;gap:8px;justify-content:flex-end;padding:10px 16px}
    .btn{background:#101939;color:#e6eeff;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:12px 14px;cursor:pointer}
    .btn:hover{filter:brightness(1.05)}
    /* ปุ่มปิด (X) สำหรับมือถือ: hit-target ≥ 44px */
    .icon-close{
      width:44px;height:44px;display:inline-flex;align-items:center;justify-content:center;
      border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0e1736;color:#e8eefc;cursor:pointer
    }
    .icon-close:hover{filter:brightness(1.05)}
    .icon-close svg{width:22px;height:22px}
    body.modal-open{overflow:hidden}

    @media (max-width:820px){
      .controls{grid-template-columns:1fr 1fr}
      header{flex-direction:column;align-items:flex-start}
      .btn{padding:12px 16px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <h1>ตารางทุนที่ต้องใช้และความเสี่ยง — Fibonacci × (เริ่มต้น ÷ ค่าน้ำ)</h1>
        <span class="tag">เดิมพัน/สเต็ป ปัดทศนิยม 1 ตำแหน่ง</span>
      </header>

      <div class="controls">
        <div class="field">
          <label for="odds">ค่าน้ำ (เช่น 0.85)</label>
          <input id="odds" type="number" step="0.01" min="0.01" value="0.85">
        </div>
        <div class="field">
          <label for="startBet">เริ่มต้นตาละ (บาท)</label>
          <input id="startBet" type="number" step="0.1" min="0.1" value="25">
        </div>
        <div class="field">
          <label for="numSteps">จำนวนสเต็ป</label>
          <input id="numSteps" type="number" step="1" min="1" value="15">
        </div>
        <div class="field">
          <button class="primary" id="calcBtn" type="button">คำนวณ</button>
        </div>
      </div>

      <div class="summary" id="summary"></div>

      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th style="width:90px">สเต็ป (Fibo)</th>
              <th class="right">เดิมพัน/สเต็ป</th>
              <th class="right">ตัวคูณ Fibo</th>
              <th class="right">ทุนสะสม</th>
              <th class="right">โอกาสแพ้รวด i สเต็ป</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      <div style="padding:12px 16px" class="muted">
        * เงินเดิมพันสเต็ปที่ <b>i</b> = <b>Fibonacci(i)</b> × (เริ่มต้นตาละ ÷ ค่าน้ำ) โดย <u>ปัดหน่วยฐานเป็นทศนิยม 1 ตำแหน่งก่อน</u> เช่น 25/0.85 → 29.4
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <header>
        <h1 id="modalTitle" style="font-size:18px;margin:0"></h1>
        <button class="icon-close" id="closeModalX" aria-label="ปิด">
          <svg viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </header>
      <div class="content" id="modalContent"></div>
      <div class="actions">
        <button class="btn" id="closeModal">ปิด</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (sel)=>document.querySelector(sel);
    const fmt0 = n => n.toLocaleString('th-TH', {minimumFractionDigits:0, maximumFractionDigits:0});
    const fmt1 = n => n.toLocaleString('th-TH', {minimumFractionDigits:1, maximumFractionDigits:1});
    const pct6 = p => (p*100).toLocaleString('th-TH', {minimumFractionDigits:6, maximumFractionDigits:6}) + '%';
    const round1 = x => Math.round(x*10)/10;

    function fib(n){
      if(n<=2) return 1;
      let a=1,b=1; for(let i=3;i<=n;i++){ [a,b] = [b,a+b] } return b;
    }

    function generateScheduleFibo(odds, startBet, num){
      const unit = round1(startBet / odds); // ปัด 1 ตำแหน่งตั้งแต่หน่วยฐาน
      const rows = [];
      let cum = 0;
      for(let i=1;i<=num;i++){
        const mult = fib(i);                 // 1,1,2,3,5,8,...
        const stake = round1(mult * unit);   // ปัด 1 ตำแหน่ง
        cum = round1(cum + stake);           // ทุนสะสม (ปัด 1 ตำแหน่ง)
        rows.push({ i, mult, stake, cum, pLoseStreak: Math.pow(0.5, i) });
      }
      return { rows, unit };
    }

    function ensureScheduleLengthFibo(odds, startBet, needLen, current){
      if(current.rows.length >= needLen) return current;
      return generateScheduleFibo(odds, startBet, needLen);
    }

    // ✅ สร้างแพทเทิร์นจาก "จำนวนรอบ"
    // รอบ = 0 => WW
    // รอบ ≥ 1 => (LW ซ้ำตามจำนวนรอบ) แล้ว + W ปิดท้าย
    function buildPattern(rounds){
      if (rounds === 0) return ['W','W'];
      const seq = [];
      for (let i = 0; i < rounds; i++) seq.push('L','W');
      seq.push('W');
      return seq;
    }

    // เดินสเต็ป: แพ้ +1 / ชนะ −1 (ไม่ต่ำกว่าสเต็ป 1)
    // รวม "ยอดยกมา" = -ทุนสะสมก่อนหน้า ตั้งแต่ลำดับแรก
    function simulatePattern(startStep, odds, startBet, baseSchedule, rounds){
      let schedule = baseSchedule;
      let step = startStep;

      if(step > schedule.rows.length){
        schedule = ensureScheduleLengthFibo(odds, startBet, step, schedule);
      }
      const prevCum = step>1 ? schedule.rows[step-2].cum : 0; // ทุนสะสมก่อนหน้า
      const carryIn = -prevCum; // ยอดยกมา

      const pattern = buildPattern(rounds);
      let cumNet = carryIn;
      let totalStake = 0;
      let maxStepUsed = step;
      const lines = [];

      for(let t=1; t<=pattern.length; t++){
        if(step < 1) step = 1;
        if(step > schedule.rows.length){
          schedule = ensureScheduleLengthFibo(odds, startBet, step, schedule);
        }
        const row = schedule.rows[step-1];
        const stake = row.stake;
        const outcome = pattern[t-1];
        const net = outcome==='W' ? round1(odds * stake) : -stake;

        totalStake = round1(totalStake + stake);
        cumNet = round1(cumNet + net);

        lines.push({ turn:t, outcome, step, stake, net, cumNet });

        // อัปเดตสเต็ป
        step = (outcome==='W') ? Math.max(1, step - 1) : (step + 1);
        maxStepUsed = Math.max(maxStepUsed, lines[lines.length-1].step);
      }

      return { pattern: pattern.join(''), lines, totalStake, cumNet, maxStepUsed, carryIn, prevCum, rounds };
    }

    function renderTable(odds, startBet, num){
      const { rows, unit } = generateScheduleFibo(odds, startBet, num);
      const tbody = $('#tableBody');
      tbody.innerHTML = '';

      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.classList.add('clickable');
        tr.dataset.step = String(r.i);
        tr.innerHTML = `
          <td><span class="tag">สเต็ป ${r.i}</span></td>
          <td class="right">${fmt1(r.stake)}</td>
          <td class="right muted">${fmt0(r.mult)}</td>
          <td class="right">${fmt1(r.cum)}</td>
          <td class="right muted">${pct6(r.pLoseStreak)}</td>
        `;
        tr.title = 'แตะเพื่อจำลองลำดับ เริ่มที่สเต็ปนี้';
        tbody.appendChild(tr);
      });

      const totalCap = rows[rows.length-1]?.cum ?? 0;
      $('#summary').innerHTML = `
        <span class="pill">หน่วยฐาน (เริ่มต้น ÷ ค่าน้ำ): <b>${fmt1(unit)}</b> บาท</span>
        <span class="pill">ทุนรวมสูงสุดถึงสเต็ปที่กำหนด: <b>${fmt1(totalCap)}</b> บาท</span>
        <span class="pill">เดิมพันสูงสุด (ใน ${num} สเต็ป): <b>${fmt1(Math.max(...rows.map(x=>x.stake)))}</b> บาท</span>
      `;

      tbody.querySelectorAll('tr.clickable').forEach(tr=>{
        tr.addEventListener('click', ()=>{
          const step = Number(tr.dataset.step);
          openModal(step, odds, startBet, {rows, unit});
        });
      });
    }

    function openModal(step, odds, startBet, schedule){
      // Header ป๊อปอัป + ตัวเลือกจำนวนรอบ
      $('#modalTitle').innerHTML = `จำลองลำดับสลับ <span class="tag">LW</span> ตามจำนวนรอบ และ <span class="tag">+ W ปิดท้าย</span> — เริ่มที่สเต็ป <b>${step}</b>`;

      const controls = `
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px;align-items:flex-end">
          <span class="pill">ค่าน้ำ: <b>${odds}</b></span>
          <span class="pill">เริ่มต้นตาละ: <b>${fmt1(Number(startBet))}</b> บาท</span>
          <span class="pill">หน่วยฐาน = เริ่มต้น/ค่าน้ำ: <b>${fmt1(schedule.unit)}</b> บาท</span>

          <div class="field" style="min-width:220px">
            <label for="roundsSel" style="font-size:13px;color:#a9b3c7">
              จำนวนรอบ (0–9) — <b>0 = WW</b>, 1 = LW + W, 2 = LWLW + W, 3 = LWLWLW + W, …
            </label>
            <select id="roundsSel" style="background:#0d132a;color:#e8eefc;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:10px 12px">
              ${Array.from({length:10}, (_,i)=>`<option value="${i}" ${i===2?'selected':''}>${i} รอบ</option>`).join('')}
            </select>
          </div>
        </div>
        <div id="simArea"></div>
      `;

      $('#modalContent').innerHTML = controls;

      function renderSimArea(rounds){
        const sim = simulatePattern(step, odds, startBet, schedule, rounds);
        const overflow = sim.maxStepUsed > schedule.rows.length;
        const warn = overflow
          ? `<div class="pill" style="background:#2a1116;border-color:#3d1a21;color:#ffc2c2; margin:6px 0">ขยายจำนวนสเต็ปชั่วคราวถึงสเต็ป ${sim.maxStepUsed} เพื่อจำลอง</div>`
          : '';

        const rowsHtml = sim.lines.map(l=>`
          <tr>
            <td class="right">${l.turn}</td>
            <td class="right">${l.outcome}</td>
            <td class="right">สเต็ป ${l.step}</td>
            <td class="right">${fmt1(l.stake)}</td>
            <td class="right ${l.net>=0?'':'muted'}">${l.net>=0?('+'+fmt1(l.net)):fmt1(l.net)}</td>
            <td class="right"><b>${(l.cumNet>=0?'+':'')+fmt1(l.cumNet)}</b></td>
          </tr>
        `).join('');

        $('#simArea').innerHTML = `
          <div style="display:flex;gap:12px;flex-wrap:wrap;margin:6px 0 10px 0">
            <span class="pill">รูปแบบ: <b>${sim.pattern}</b></span>
            <span class="pill">ยอดยกมา (ขาดทุนก่อนหน้า): <b>${fmt1(sim.carryIn)}</b> บาท</span>
            ${warn}
          </div>

          <div class="scroll" style="max-height:48vh;border-top:1px solid rgba(255,255,255,.06)">
            <table>
              <thead>
                <tr>
                  <th>ลำดับ</th>
                  <th class="right">ผล</th>
                  <th class="right">สเต็ปที่ใช้ (Fibo)</th>
                  <th class="right">เดิมพัน (บาท)</th>
                  <th class="right">กำไร/ขาดทุน</th>
                  <th class="right">กำไรรวมสะสม</th>
                </tr>
              </thead>
              <tbody>${rowsHtml}</tbody>
            </table>
          </div>

          <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
            <span class="pill">ทุนสะสมก่อนหน้า: <b>${fmt1(sim.prevCum)}</b> บาท</span>
            <span class="pill">ทุนที่ใช้ในลำดับนี้ (${sim.lines.length} แถว): <b>${fmt1(sim.totalStake)}</b> บาท</span>
            <span class="pill">กำไรรวมเมื่อจบลำดับ: <b>${(sim.cumNet>=0?'+':'')+fmt1(sim.cumNet)}</b> บาท</span>
          </div>
        `;
      }

      // render ครั้งแรกด้วยค่าเริ่มต้น 2 รอบ
      renderSimArea(2);

      // เปลี่ยนจำนวนรอบ
      const sel = $('#roundsSel');
      sel.addEventListener('change', ()=> renderSimArea(Number(sel.value)));

      // เปิด modal
      const back = $('#modalBackdrop');
      back.style.display = 'flex';
      back.setAttribute('aria-hidden','false');
      document.body.classList.add('modal-open');

      // โฟกัสปุ่ม X เพื่อการเข้าถึงที่ดีขึ้น
      const xbtn = $('#closeModalX'); if (xbtn) try { xbtn.focus(); } catch(e){}
    }

    function closeModal(){
      document.body.classList.remove('modal-open');
      const back = $('#modalBackdrop');
      back.style.display = 'none';
      back.setAttribute('aria-hidden','true');
    }

    // ปิดแบบต่าง ๆ (เพื่อใช้งานง่ายบนมือถือ)
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
    document.addEventListener('click', (e)=>{
      if(e.target && e.target.id === 'modalBackdrop') closeModal();
    });
    // ปุ่มปิด
    document.addEventListener('click', (e)=>{
      if(e.target && (e.target.id === 'closeModal' || e.target.id === 'closeModalX')) closeModal();
    });

    $('#calcBtn').addEventListener('click', ()=>{
      const odds = Number($('#odds').value);
      const startBet = Number($('#startBet').value);
      const numSteps = Number($('#numSteps').value);
      if(!(odds>0 && startBet>0 && numSteps>=1)){
        alert('กรุณากรอกข้อมูลให้ถูกต้อง');
        return;
      }
      renderTable(odds, startBet, numSteps);
    });

    // initial render
    renderTable(Number($('#odds').value), Number($('#startBet').value), Number($('#numSteps').value));
  </script>
</body>
</html>
